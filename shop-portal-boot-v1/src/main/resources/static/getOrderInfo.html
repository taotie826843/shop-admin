<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <title>结算页</title>
    <link rel="stylesheet" href="/js/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
    <link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
</head>
<body>
<!--导航条-->
<div id="navId"></div>


<div class="cart py-container" id="badyDiv">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">
            <form class="sui-form form-inline">
                <div class="input-append">
                    <input type="text" type="text" class="input-error input-xxlarge" placeholder="随心所欲" />
                    <button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
                </div>
            </form>
        </div>
    </div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息<span><a href="#" class="btn btn-primary" role="button" onclick="saveSite()">新增收货地址</a></span></h5>
            </div>
            <!--填写并核对订单信息-->
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item" id="orderSiteDivs">
                            <!--<div>
                                <div class="con name selected"><a href="javascript:;" >张默<span title="点击取消选择">&nbsp;</a></div>
                                <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span>
                                    <span class="base">默认地址</span>
                                    <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
                                </div>
                                <div class="clearfix"></div>
                            </div>-->
                            <div>
                                <div class="con name"><a href="javascript:;"><i id="consigneeNameOrder">##consigneeName##</i><span title="点击取消选择"></span>&nbsp;</a></div>
                                <div class="con address">##consigneeName## <span id="shippingSiteOrder">##minuteSite##</span>  <span id="consigneePhoneOrder">##phone##</span>
                                    <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </li>


                    </ul>
                    <!--添加地址-->
                    <div  style="display: none" id="AddSite">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">收货人：</label>
                                <div class="col-sm-10">
                                    <input type="text" name="consigneeName" class="form-control" id="consigneeName"  placeholder="收货人">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">详细地址：</label>
                                <div class="col-sm-10">
                                    <input type="text" name="minuteSite" id="minuteSite" class="form-control" placeholder="详细地址">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">联系电话：</label>
                                <div class="col-sm-10">
                                    <input type="text" name="phone" id="phone" class="form-control" placeholder="联系电话">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">邮箱：</label>
                                <div class="col-sm-5">
                                    <input type="email" name="email" id="email" class="form-control" placeholder="邮箱">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">地址别名：</label>
                                <div class="col-sm-10">
                                    <input type="text" name="siteAlias" class="form-control" id="siteAlias" placeholder="地址别名">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">建议填写常用地址：</label>
                                <div class="col-sm-10">
                                    <input type="text" name="commonSite" id="commonSite" class="form-control" placeholder="建议填写常用地址">
                                </div>
                            </div>

                        </form>
                    </div>
                    <!--确认地址-->
                </div>
                <div class="hr"></div>

            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected" value="1">微信付款<span title="点击取消选择"></span></li>
                        <li value="2">支付宝付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont">
                    <ul class="send-detail">
                        <li>
                            <div class="sendGoods" id="orderInfoDiv">

                            </div>
                        </li>
                    </ul>
                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary">
        <div class="static fr">
            <div class="list">
                <span><i class="number" id="totalCount"></i>件商品，总商品金额</span>
                <em class="allprice" id="totalPrice"></em>
            </div>
            <div class="list">
                <span>返现：</span>
                <em class="money">0.00</em>
            </div>
            <div class="list">
                <span>运费：</span>
                <em class="transport">0.00</em>
            </div>
        </div>
    </div>
    <div class="clearfix trade">
        <div class="fc-price">应付金额:　<span class="price" id="totalPrices"></span></div>
        <div class="fc-receiverInfo">寄送至:北京市海淀区三环内 中关村软件园9号楼 收货人：某某某 159****3201</div>
    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" onclick="present()">提交订单</a>
    </div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>帮助中心</h4>
                        <img src="img/wx_cz.jpg">
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!--展示商品模板-->
<div id="orderInfoId" style="display: none">
    <ul class="yui3-g">
        <li class="yui3-u-1-6">
            <span><img src="##image##"/></span>
        </li>
        <li class="yui3-u-7-12">
            <div class="desc">##productName##</div>
            <div class="seven">7天无理由退货</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="price">￥##subTotalPrice##</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="num">X##count##</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="exit">有货</div>
        </li>
    </ul>
    <!--<div>
        <div class="con name"><a href="javascript:;"><i id="consigneeNameOrder">##consigneeName##</i><span title="点击取消选择"></span>&nbsp;</a></div>
        <div class="con address">##consigneeName## <span id="shippingSiteOrder">##minuteSite##</span>  <span id="consigneePhoneOrder">##phone##</span>
            <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
        </div>
        <div><input type="radio" name="orders">选择</div>
        <div class="clearfix"></div>
    </div>-->

</div>

<!--提交返回模板-->
<div id="returnInfoId" style="display: none">

    <div class="step-cont">
        <ul class="send-detail">
            <li>
                <div class="sendGoods" id="orderInfoDiv">


    <ul class="yui3-g">
        <li class="yui3-u-1-6">
            <span><img src="##image##"/></span>
        </li>
        <li class="yui3-u-7-12">
            <div class="desc">##productName##</div>
            <div class="seven">7天无理由退货</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="price">￥##subTotalPrice##</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="num">X##count##</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="exit">缺货</div>
        </li>
    </ul>

                </div>
            </li>
        </ul>
    </div>
    <!--<div>
        <div class="con name"><a href="javascript:;"><i id="consigneeNameOrder">##consigneeName##</i><span title="点击取消选择"></span>&nbsp;</a></div>
        <div class="con address">##consigneeName## <span id="shippingSiteOrder">##minuteSite##</span>  <span id="consigneePhoneOrder">##phone##</span>
            <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
        </div>
        <div><input type="radio" name="orders">选择</div>
        <div class="clearfix"></div>
    </div>-->

</div>

<!--展示地址信息模板-->
<div id="orderSiteDiv" style="display: none">
    <div>
        <div class="con name"><a href="javascript:;">##consigneeName##<span title="点击取消选择"></span>&nbsp;</a></div>
        <div class="con address">##consigneeName## ##minuteSite##  <span>##phone##</span>
            <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
        </div>
        <div class="clearfix"></div>
    </div>
    <!--<div>
        <div class="con name selected"><a href="javascript:;" >张默<span title="点击取消选择">&nbsp;</a></div>
        <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span>
            <span class="base">默认地址</span>
            <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" >编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
        </div>
        <div class="clearfix"></div>
    </div>-->
</div>


<script src="/js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/components/ui-modules/nav/nav-portal-top.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script src="/js/common/nav.js"></script>
<script src="/js/bootstrap/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.min.js"></script>
<script src="/js/bootbox/bootbox.min.js"></script>


<script>
    var orderSiteHtml;
    $(function(){
        if(!loginFlag){
            $("#badyDiv").html("<div style='text-align: center;font-size: 15px'><li><font size='8'>您还没有登录，<a href='/login.html'>登录          </a>或<a href='addMember.html'>        注册</font></a></li></div>");
        }else{
            initQueryList();
            initOrderSite();
            orderSiteHtml = $("#AddSite").html();
    }
    })
    //送货清单
    function  initQueryList(){
        $.post({
            url:"http://localhost:8081/cart/toList.wl",
            success:function(result){
                if(result.code==200){
                    var dataArr = result.data.cartItem;
                    var v_orderHtml=$("#orderInfoId").html();
                    var v_html="";
                    for(var i=0;i<dataArr.length;i++){
                        var cart=dataArr[i];
                        v_html += v_orderHtml.replace(/##productName##/g,cart.productName)
                            .replace(/##image##/g,cart.image)
                            .replace(/##subTotalPrice##/g,cart.subTotalPrice)
                            .replace(/##count##/g,cart.count);
                    }
                    $("#orderInfoDiv").html(v_html);
                    $("#totalCount").html(result.data.totalCount)
                    $("#totalPrice").html(result.data.totalPrice)
                    $("#totalPrices").html(result.data.totalPrice)

                }else if(result.code==1017){
                    $("#badyDiv").html("<div style='text-align: center;font-size: 18px'>商品信息为空,<a href='index.html'>选购</a></div>");
                }
            }
        })
    }

    //订单地址信息
    function initOrderSite() {
        $.post({
            url:"http://localhost:8081/site/findOrderSite.wl",
            success:function (result) {
                if (result.code == 200) {
                    var orderHtml = $("#orderSiteDivs").html();
                    var v_html ="";
                    var orderArr = result.data;
                    for (var i = 0; i < orderArr.length; i++) {
                        var order = orderArr[i];
                        v_html += orderHtml.replace(/##consigneeName##/g,order.consigneeName)
                            .replace(/##minuteSite##/g,order.minuteSite)
                            .replace(/##phone##/g,order.phone)

                    }
                    $("#orderSiteDivs").html(v_html);
                    $(function(){
                        $(".address").hover(function(){
                            $(this).addClass("address-hover");
                        },function(){
                            $(this).removeClass("address-hover");
                        });
                    })

                    $(function(){
                        $(".addr-item .name").click(function(){
                            $(this).toggleClass("selected").siblings().removeClass("selected");
                        });
                        /*$(".payType li").click(function(){
                            $(this).toggleClass("selected").siblings().removeClass("selected");
                        });*/
                    })
                }
            }
        })
    }

    //新增收获地址
    var tables;
    function saveSite() {
        tables = bootbox.dialog({
            title: '用户增加',
            message: $("#AddSite form"),
            size: 'large',
            backdrop:false,
            buttons: {
                cancel: {
                    label: "提交",
                    className: 'btn-info',
                    callback: function(){
                        var v_consigneeName = $("#consigneeName",tables).val();
                        var v_minuteSite = $("#minuteSite",tables).val();
                        var v_phone = $("#phone",tables).val();
                        var v_email = $("#email",tables).val();
                        var v_siteAlias = $("#siteAlias",tables).val();
                        var v_commonSite = $("#commonSite",tables).val();
                        //定义一个json
                        var param = {};
                        param.consigneeName = v_consigneeName;
                        param.minuteSite = v_minuteSite;
                        param.phone = v_phone;
                        param.email = v_email;
                        param.siteAlias = v_siteAlias;
                        param.commonSite = v_commonSite;
                        $.ajax({
                            url:"http://localhost:8081/site/addSite.wl",
                            type:"post",
                            async:false,
                            data:param,
                            success:function (res) {
                                if (res.code==200){
                                    location.href="/getOrderInfo.html";
                                }
                            },
                            error:function (res) {
                                alert("错误")
                            }
                        })
                    }
                },
                ok: {
                    label: "取消",
                    className: 'btn-danger',
                    callback: function(){
                        console.log('Custom OK clicked');
                    }
                }
            }
        });
        $("#AddSite").html(orderSiteHtml);
    }

    //提交
    function present() {
        //var v_html = $("input[name='orders']:checked").parent().parent().html();
        var v_html = $(".con name selected").parent().html();
        var consigneeName = $("#consigneeNameOrder",v_html).html();
        var shippingSite = $("#shippingSiteOrder",v_html).html();
        var consigneePhone = $("#consigneePhoneOrder",v_html).html();
        /*var v_consigneeName = $(".con name selected").val();
        var consigneeName = $("#consigneeNameOrder",v_consigneeName);*/

        var payType = $(".selected").attr("value");
        var param = {};
        param.consigneeName = consigneeName;
        param.shippingSite = shippingSite;
        param.consigneePhone = consigneePhone;
        param.payType = payType;
        $.post({
            url: "http://localhost:8081/orders/saveOrder.wl",
            data:param,
            async:false,
            beforeSend:function(xhr){
                var heads = $.cookie("fh_id");
                var tokens = $.cookie("token");
                xhr.setRequestHeader("x-auth",heads);
                xhr.setRequestHeader("token",tokens);
            },
            success:function (result) {
                if (result.code == 200) {
                    if (result.data.length < 1) {
                        location.href = "/pay.html";
                    }else{
                        var v_data = result.data;
                        var v_orderHtml=$("#returnInfoId").html();
                        var v_html="";
                        for (var i = 0; i < v_data.length; i++) {
                            var cart=v_data[i];
                            v_html += v_orderHtml.replace(/##productName##/g,cart.productName)
                                .replace(/##image##/g,cart.image)
                                .replace(/##subTotalPrice##/g,cart.subTotalPrice)
                                .replace(/##count##/g,cart.count);
                        }
                        bootbox.dialog({
                            title: '缺货商品，其他品牌可正常购买',
                            message: v_html,
                            //size: 'large',
                            backdrop:false,
                            buttons: {
                                cancel: {
                                    label: "提交",
                                    className: 'btn-info',
                                    callback: function(){
                                        location.href = "/pay.html";
                                    }
                                },
                                /*ok: {
                                    label: "取消",
                                    className: 'btn-danger',
                                    callback: function(){
                                        console.log('Custom OK clicked');
                                    }
                                }*/
                            }
                        });
                    }
                }else {
                    alert(result.msg)
                }
            }
        })
    }

</script>
</body>
</html>